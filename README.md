# Kessel SDK for Python

A Python SDK for connecting to Kessel services using gRPC.

## Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [Client Builder](#client-builder)
- [Configuration](#configuration)
  - [Target Server](#target-server)
  - [Credentials](#credentials)
  - [Keep-Alive Settings](#keep-alive-settings)
- [Authentication](#authentication)
- [Examples](#examples)
- [API Reference](#api-reference)
- [Error Handling](#error-handling)
- [Development](#development)


## Installation

```bash
pip install kessel-sdk
```

## Quick Start

```python
import grpc

from kessel.inventory.v1beta2 import (
    ClientBuilder, 
    rbac, 
    check_request_pb2,
    resource_reference_pb2, 
    reporter_reference_pb2
)

# Build a stub pointing at a local instance
stub = (
    ClientBuilder
    .with_defaults_localhost(9000)
    .build_inventory_stub()
)

# Build helper objects
subject = rbac.principal_subject_for_user_id("alice", "localhost")
resource_ref = resource_reference_pb2.ResourceReference(
    resource_id="alice_club",
    resource_type="group",
    reporter=reporter_reference_pb2.ReporterReference(type="rbac"),
)

check_request = check_request_pb2.CheckRequest(
   subject=subject,
   relation="member",
   object=resource_ref,
)

try:
    check_response = stub.Check(check_request)
    print("Check response received successfully")
    print(check_response)
except grpc.RpcError as e:
    print("gRPC error occurred during Check:")
    print(f"Code: {e.code()}")
    print(f"Details: {e.details()}")
```


## Client Builder

The Kessel SDK uses a builder pattern to create gRPC channels and service stubs. You should reuse the same channel and stub instances for multiple API calls, as creating
a channel is expensive. 
`BaseClientBuilder` provides:

* **Channel and Stub caching** – reuse connections automatically
* **Reasonable defaults** – keep-alive tuned for production & development
* **AsyncIO support** – Switch to `grpc.aio` for asynchronous tasks by calling `with_asyncio()` on the ClientBuilder


## Configuration

### Target Server

The only required value is the target address (host:port):

```python
ClientBuilder.with_defaults_insecure("localhost:9000")
ClientBuilder.with_defaults_localhost(9000)
ClientBuilder.with_defaults(target="kessel.example.com:443", call_creds=...)
```

### Credentials

* **Insecure (Development)** – generated by `.with_defaults_insecure()` or explicit insecure channel
* **Secure (Production)** – pass `grpc.ssl_channel_credentials()` or your own certificate bundle:

```python
from pathlib import Path, PurePath

root_certs = Path("root.pem").read_bytes()
call_creds = grpc.access_token_call_credentials("TOKEN")

builder = (
    ClientBuilder()
    .with_defaults(
        target="kessel.example.com:443",
        call_credentials=call_creds,
        channel_credentials=grpc.ssl_channel_credentials(root_certs),
    )
)
```

### Keep-Alive Settings

Keep-alive can be customised. Otherwise defaults are applied (time = 10 s, timeout = 5 s, max-pings = 12, permit-without-calls = True).

```python
builder.with_keep_alive(time_ms=30000, timeout_ms=10000, max_pings=5, permit_without_calls=False)
```

## Authentication

Version `1.1.0` will support OAuth 2.0 Client Credentials for authentication.

## Examples

The `examples/` directory contains runnable samples:

* **check.py** – Basic unary call
* **streamed_list_objects.py** – Working with streaming APIs

Run an example:

```bash
python -m examples.check
```

The SDK also provides some helper functions in the `kessel.inventory.v1beta2.rbac` package.

### Listing workspaces
Easily list all workspaces a user has a speciifc relation to using the `list_workspaces` function.

```python
import grpc
from kessel.inventory.v1beta2 import ClientBuilder, rbac

stub = ClientBuilder.with_defaults_localhost(9000).build_inventory_stub()

# Create a subject reference for the user
subject = rbac.principal_subject_for_user_id("alice", "localhost")

# Call the helper to list workspaces where the user is a "member"
print("Workspaces where 'alice' is a 'member':")
try:
    for response in rbac.list_workspaces(subject=subject, relation="member", inventory=stub):
        print(response)
except grpc.RpcError as e:
    print(f"gRPC error occurred: {e.details()}")
```

## API Reference

| Method | Parameters | Returns | Description |
| ------ | ---------- | ------- | ----------- |
| `with_defaults_insecure(target)` | `target: str` | `ClientBuilder` | Insecure channel with defaults (dev only) |
| `with_defaults_localhost(port, call_creds=None)` | `port: int`, `call_creds: grpc.CallCredentials \| None` | `ClientBuilder` | Secure localhost credentials |
| `with_defaults(target, call_creds, channel_creds)` | `target: str`, `call_creds: grpc.CallCredentials`, `channel_creds: grpc.ChannelCredentials` | `ClientBuilder` | Secure channel with sane defaults |
| `with_asyncio()` | - | `ClientBuilder` | Switch to `grpc.aio` implementation |
| `with_keep_alive(time_ms, timeout_ms, max_pings, permit_without_calls)` | `time_ms: int`, `timeout_ms: int`, `max_pings: int`, `permit_without_calls: bool` | `ClientBuilder` | Fine-tune keep-alive |
| `build_channel()` | - | `grpc.Channel` | Build a new channel |
| `build_channel_or_get_existing(cacheKey)` | `cacheKey: Hashable` | `grpc.Channel` | Re-use cached or build new channel |
| `build_stub(factory)` | `Callable` | gRPC Stub | Build stub for factory |
| `build_or_get_existing_stub(cacheKey, factory)` | `cacheKey: Hashable`, `Callable` | gRPC Stub | Cached stub convenience |
| `build_inventory_stub()` | - | `KesselInventoryServiceStub` | Convenience for inventory service |

## Error Handling

The SDK uses standard gRPC status codes:

```python
try:
    resp = stub.Check(request)
except grpc.RpcError as err:
    if err.code() == grpc.StatusCode.PERMISSION_DENIED:
        ...
    elif err.code() == grpc.StatusCode.UNAVAILABLE:
        ...
```

## Need Help?

- Check the [GitHub Issues](https://github.com/project-kessel/kessel-sdk-py/issues)
- Browse the [examples](./examples) directory

## Development

First, install dev tools:

```bash
pip install "kessel-sdk[dev]"
```

Format and lint **excluding generated gRPC files** (`*_pb2.py` and `*_pb2_grpc.py`):

```bash
# Auto-format source & examples
black --exclude '.*_pb2(_grpc)?\.py' src/ examples/

# Lint source & examples
flake8 --exclude '*_pb2.py,*_pb2_grpc.py' src/ examples/
```

Regenerate protobuf & gRPC stubs (requires latest [buf CLI](https://github.com/bufbuild/buf)):

```bash
buf generate buf.build/project-kessel/inventory-api
```

## License

This project is licensed under the Apache License 2.0. See the [LICENSE](LICENSE) file for details.


